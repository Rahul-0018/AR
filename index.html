<!DOCTYPE html>
<html>
  <head>
    <title>WebXR AR Hit Test with Tap Placement</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>    
    <style>
      body { margin: 0; overflow: hidden; }
      #logBox {
        position: fixed;
        top: 10px; left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: #0f0;
        padding: 10px;
        font-family: monospace;
        font-size: 14px;
        max-width: 90%;
        max-height: 50%;
        overflow-y: auto;
        z-index: 9999;
        border-radius: 8px;
      }
      #enter-ar {
        position: fixed;
        top: 10px; right: 10px;
        z-index: 10000;
        font-size: 18px;
        padding: 8px 12px;
      }
    </style>
  </head>
  <body>
    <div id="logBox">üìã Logs:<br></div>
    <button id="enter-ar">Enter AR</button>

    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      renderer="colorManagement: true; physicallyCorrectLights: true"
      xrweb="optionalFeatures: hit-test"
      arjs="sourceType: webcam; debugUIEnabled: false"
      webxr>
      
      <a-entity id="camera" camera look-controls wasd-controls position="0 1.6 0"></a-entity>

      <!-- Reticle to show hit test position -->
      <a-entity id="reticle" laser-controls="hand: right" visible="false" geometry="primitive: ring; radiusInner: 0.03; radiusOuter: 0.04" material="color: cyan; shader: flat" rotation="-90 0 0"></a-entity>

      <!-- 3D model to place -->
      <a-entity id="model" gltf-model="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/DamagedHelmet/glTF/DamagedHelmet.gltf" scale="0.5 0.5 0.5" visible="false"></a-entity>
    </a-scene>

    <script>
      const logBox = document.getElementById('logBox');
      function addLog(msg) {
        console.log(msg);
        logBox.innerHTML += msg + '<br>';
        logBox.scrollTop = logBox.scrollHeight;
      }

      const scene = document.querySelector('a-scene');
      const reticle = document.getElementById('reticle');
      const model = document.getElementById('model');
      const enterARButton = document.getElementById('enter-ar');

      let xrSession = null;
      let xrReferenceSpace = null;
      let hitTestSource = null;
      let hitTestSourceRequested = false;

      enterARButton.addEventListener('click', async () => {
        if (navigator.xr) {
          try {
            xrSession = await navigator.xr.requestSession('immersive-ar', {requiredFeatures: ['hit-test']});
            addLog('üöÄ AR session started.');
            scene.renderer.xr.setSession(xrSession);

            xrReferenceSpace = await xrSession.requestReferenceSpace('viewer');
            const viewerSpace = await xrSession.requestReferenceSpace('viewer');

            hitTestSource = await xrSession.requestHitTestSource({space: viewerSpace});

            hitTestSourceRequested = true;
            enterARButton.style.display = 'none';
            reticle.setAttribute('visible', 'true');

            xrSession.addEventListener('end', () => {
              addLog('‚ùå AR session ended.');
              hitTestSourceRequested = false;
              xrSession = null;
              hitTestSource = null;
              reticle.setAttribute('visible', 'false');
              enterARButton.style.display = 'block';
              model.setAttribute('visible', 'false');
            });

            const onXRFrame = (time, frame) => {
              xrSession.requestAnimationFrame(onXRFrame);

              if (!hitTestSourceRequested) return;

              const referenceSpace = xrReferenceSpace;
              const hitTestResults = frame.getHitTestResults(hitTestSource);
              
              if (hitTestResults.length > 0) {
                const hit = hitTestResults[0];
                const pose = hit.getPose(referenceSpace);
                if (pose) {
                  const pos = pose.transform.position;
                  const rot = pose.transform.orientation;
                  reticle.object3D.position.set(pos.x, pos.y, pos.z);
                  reticle.object3D.quaternion.set(rot.x, rot.y, rot.z, rot.w);
                  reticle.setAttribute('visible', 'true');
                  addLog('üìç Hit detected at ' + JSON.stringify(pos));
                }
              } else {
                reticle.setAttribute('visible', 'false');
              }
            };
            xrSession.requestAnimationFrame(onXRFrame);

          } catch (e) {
            addLog('‚ùå Failed to start AR session: ' + e);
          }
        } else {
          addLog('‚ùå WebXR not supported on this device/browser.');
        }
      });

      // Place model on reticle tap
      window.addEventListener('click', () => {
        if (reticle.getAttribute('visible') === 'true' && model) {
          const pos = reticle.object3D.position;
          const rot = reticle.object3D.quaternion;
          model.object3D.position.copy(pos);
          model.object3D.quaternion.copy(rot);
          model.setAttribute('visible', 'true');
          addLog('üëÜ Model placed at: ' + JSON.stringify(pos));
        } else {
          addLog('‚ö†Ô∏è Tap ignored: no hit test position detected.');
        }
      });
    </script>
  </body>
</html>
